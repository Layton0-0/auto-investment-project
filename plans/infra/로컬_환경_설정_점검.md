# 로컬 환경 설정 점검 (503 / URL 의존)

**일시**: 2026-02-21  
**목적**: `docker-compose.local-full.yml` 로컬 풀 스택에서, 백엔드가 특정 환경변수·URL 미설정으로 **503** 또는 **연결 실패**를 일으키는 지점을 정리하고, 단계별로 점검할 수 있도록 한다.

---

## 1. 503 / 연결실패 가능 지점 요약

| 구분 | API/기능 | 설정 키 (환경변수) | 미설정 시 동작 | 비고 |
|------|----------|-------------------|----------------|------|
| **503 반환** | `POST /api/v1/news/collect` | `investment.data.us.collector-url` (`US_COLLECTOR_URL`) | 503 + message "데이터 수집기 URL 미설정" | NewsController 단일 지점 |
| **연결 실패** | 헬스 체크·예측 API | `investment.ai.prediction-service.url` (`AI_PREDICTION_SERVICE_URL`) | Docker 내부에서 `localhost:8000`은 backend 자신을 가리켜 예측 서비스 연결 실패 | OpsHealthService, AnalysisService, FastApiPredictionClient |
| **수집기 503** | `POST /api/v1/news/collect` → data-collector | data-collector 컨테이너의 `DATA_COLLECTION_INTERNAL_KEY` | 수집기가 Spring으로 결과 전송 시 키 미설정이면 503 "DATA_COLLECTION_INTERNAL_KEY not set" | data-collector + backend 동일 키 필요 |

- **503을 반환하는 코드는 위 NewsController 한 곳뿐**이다. 단, **data-collector(Python)** 도 내부 전송 시 `DATA_COLLECTION_INTERNAL_KEY` 미설정이면 503을 반환한다.
- 그 외 KRX_AUTH_KEY 등은 선택 항목이며, 미설정 시 해당 기능만 스킵·비활성화된다.

---

## 2. docker-compose.local-full.yml — backend 환경변수 대조표

로컬 Compose에서 **backend** 서비스에 아래 항목이 설정되어 있어야 한다.

| 환경변수 | 권장 값 (로컬 풀 스택) | 용도 |
|----------|------------------------|------|
| `SPRING_PROFILES_ACTIVE` | `local` | 프로파일 |
| `SPRING_DATASOURCE_URL` | `jdbc:postgresql://timescaledb:5432/...` | DB |
| `SPRING_DATASOURCE_USERNAME` | (env) | DB |
| `SPRING_DATASOURCE_PASSWORD` | (env) | DB |
| `SPRING_DATA_REDIS_HOST` | `redis` | Redis |
| `SPRING_DATA_REDIS_PORT` | `6379` | Redis |
| **`US_COLLECTOR_URL`** | **`http://data-collector:8001`** | 뉴스·공시 수집 — 미설정 시 **503** |
| **`AI_PREDICTION_SERVICE_URL`** | **`http://prediction-service:8000`** | AI 예측·헬스 — 미설정 시 예측/헬스 실패 |
| **`DATA_COLLECTION_INTERNAL_KEY`** | **`local-internal-key`** (또는 .env) | data-collector가 Spring 내부 API 호출 시 사용. backend와 **동일 값** 필요 |

**data-collector** 서비스에도 다음이 필요하다.

| 환경변수 | 권장 값 (로컬 풀 스택) | 용도 |
|----------|------------------------|------|
| **`DATA_COLLECTION_INTERNAL_KEY`** | **`local-internal-key`** (backend와 동일) | DART/SEC 수집 후 Spring 전송 시 필수. 미설정 시 503 |
| **`SPRING_BASE_URL`** | **`http://backend:8080`** | 수집기가 Spring(backend) 호출 시 URL. Docker 호스트명 |
| **`DART_API_KEY`** | (.env에서 주입) | Open DART API 인증키. **미설정 시 DART 수집 0건** (opendart.fss.or.kr 발급) |
| **`SEC_API_KEY`** | (.env에서 주입) | SEC EDGAR API 키. **미설정 시 SEC 수집 0건** |

- `.env`로 추가 로드되는 값은 그대로 유지하고, 위 URL·키만 Compose `environment`에서 **Docker 서비스명**으로 덮어쓰는 것이 좋다.
- **뉴스 수집에서 dartSaved/secSaved가 항상 0이면** → `plans/infra/뉴스수집_0건_원인_분석.md` 참고. `DART_API_KEY`, `SEC_API_KEY` 설정 여부를 먼저 확인한다.

---

## 3. 단계별 검증 방법

로컬 풀 스택 기동 후 아래 순서로 점검하면 된다.

### 3.1 뉴스 수집 (503 여부)

- **요청**: `POST http://localhost/api/v1/news/collect` (인증 헤더 필요 시 추가)
- **기대**: 200 + `dartSaved`, `secSaved`, `message`
- **실패 시**: 503 + "데이터 수집기 URL 미설정" → `US_COLLECTOR_URL` 확인. 200이지만 `dartSaved`/`secSaved`가 0이고 로그에 "DATA_COLLECTION_INTERNAL_KEY not set" → data-collector·backend 둘 다 `DATA_COLLECTION_INTERNAL_KEY` 및 data-collector의 `SPRING_BASE_URL` 확인

### 3.2 백엔드 / 예측 서비스 헬스

- **요청**: `GET http://localhost/api/...` (Ops 헬스 또는 `/actuator/health` 등 예측 상태 포함 엔드포인트)
- **기대**: 예측 서비스 상태 UP (또는 해당 필드 존재)
- **실패 시**: 예측 서비스 DOWN / 연결 오류 → `AI_PREDICTION_SERVICE_URL=http://prediction-service:8000` 확인

### 3.3 예측 API (선택)

- 예측을 호출하는 API 사용 시 정상 응답 또는 fallback 동작 확인.
- URL 미설정 시 `localhost:8000`으로 호출되어 Docker 내부에서는 실패할 수 있음.

---

## 4. 참고 — application.yml 외부 URL·선택 항목

| 설정 키 (대표 환경변수) | 기본값/비고 |
|------------------------|-------------|
| `investment.data.us.collector-url` | `US_COLLECTOR_URL` — 로컬 Compose에서 **필수** (503 방지) |
| `investment.ai.prediction-service.url` | `AI_PREDICTION_SERVICE_URL` — 로컬 Compose에서 **권장** (예측/헬스 정상화) |
| `investment.data.krx.auth-key` | `KRX_AUTH_KEY` — 선택 (미설정 시 KRX 수집 스킵, 503 아님) |
| `investment.data.internal-api-key` | `DATA_COLLECTION_INTERNAL_KEY` — 로컬 풀 스택에서 **뉴스 수집 실제 저장** 시 필수 (data-collector·backend 동일 값, data-collector에 SPRING_BASE_URL도 필요) |

---

## 5. 변경 이력

- 2026-02-21: 최초 작성. 503 지점(NewsController), US_COLLECTOR_URL·AI_PREDICTION_SERVICE_URL 로컬 Compose 반영 및 단계별 점검 정리.
- 2026-02-21: data-collector 503 "DATA_COLLECTION_INTERNAL_KEY not set" 대응 — backend·data-collector에 DATA_COLLECTION_INTERNAL_KEY, data-collector에 SPRING_BASE_URL 추가. 점검 문서에 수집기 503·data-collector env 대조표 반영.
