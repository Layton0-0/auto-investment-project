# 뉴스·공시 수집 0건(dartSaved/secSaved 0) 원인 분석

**일시**: 2026-02-21  
**목적**: `POST /api/v1/news/collect` 호출 시 `dartSaved: 0`, `secSaved: 0`만 반환되는 원인을 Python 수집기(investment-data-collector) 코드 기준으로 분석하고, 의도대로 개발되었는지 검증한다.

---

## 1. 현상

- **API 응답**: `{"dartSaved":0,"message":"뉴스·공시 수집이 완료되었습니다.","secSaved":0}`
- **기대**: DART·SEC 공시를 수집해 DB에 저장한 뒤, 저장 건수(dartSaved, secSaved)가 0보다 큰 값으로 반환되는 경우가 있음.
- **실제**: 항상 0건으로 반환됨.

---

## 2. 흐름 요약

1. **Backend** (`NewsController`) → `DataCollectorApiClient.triggerDartCollect()`, `triggerSecCollect()` 호출.
2. **Backend** → HTTP `POST http://data-collector:8001/dart-collect`, `POST .../sec-collect` 호출.
3. **data-collector (FastAPI)**  
   - `/dart-collect`: `dart_collector.fetch_dart_for_days()` → `to_collected_items(raw)` → `_post_collected_news(items)`  
   - `/sec-collect`: `sec_edgar_collector.fetch_sec_recent_filings()` → `_post_collected_news(items)`
4. **`_post_collected_news(items)`**  
   - `items`가 **빈 리스트**이면 Spring 호출 없이 `{"received": 0, "saved": 0}` 반환.  
   - 비어 있지 않으면 Spring `POST /api/v1/internal/collected-news` 호출 후 응답 `{received, saved}` 반환.
5. **Backend**는 응답 body의 `saved` 값을 파싱해 `dartSaved`, `secSaved`로 반환.

즉, **수집 단계에서 items가 비어 있으면** Spring까지 가지 않고, 응답은 항상 `saved: 0`이 된다.

---

## 3. DART 수집에서 0건이 되는 이유

**파일**: `investment-data-collector/collectors/dart_collector.py`

- **`fetch_dart_list(bgn_de, end_de, page_no)`**  
  - **`DART_API_KEY`**가 비어 있으면 **즉시 `[]` 반환** (75–76행).  
  - Open DART API(`opendart.fss.or.kr`) 호출에 인증키가 필수이므로, 키가 없으면 API를 호출하지 않고 빈 리스트를 반환하는 것이 설계상 맞는 동작이다.
- **`fetch_dart_for_days()`**  
  - 위 `fetch_dart_list`를 페이지네이션으로 호출하므로, 키가 없으면 항상 `[]`.
- **`to_collected_items([])`** → `[]`
- **`_post_collected_news([])`** → `{"received": 0, "saved": 0}`

**결론**: **`DART_API_KEY`가 data-collector 환경에 설정되어 있지 않으면** DART 수집 결과가 항상 0건이다. 코드는 의도대로 동작한다.

---

## 4. SEC 수집에서 0건이 되는 이유

**파일**: `investment-data-collector/collectors/sec_edgar_collector.py`

- **`fetch_sec_recent_filings()`**  
  - **`SEC_API_KEY`**가 비어 있으면 **즉시 `[]` 반환** (123–124행).  
  - SEC EDGAR API 호출에 API 키가 필요하므로, 키가 없으면 호출하지 않고 빈 리스트를 반환하는 것이 설계상 맞는 동작이다.
- 이후 **`_post_collected_news([])`** → `{"received": 0, "saved": 0}`

**결론**: **`SEC_API_KEY`가 data-collector 환경에 설정되어 있지 않으면** SEC 수집 결과가 항상 0건이다. 코드는 의도대로 동작한다.

---

## 5. 종합 결론

- **Python 수집기(DART/SEC)는 의도대로 잘 개발되어 있다.**  
  - 외부 API(Open DART, SEC EDGAR) 호출을 위해 각각 **API 키가 필수**이며,  
  - 키가 **미설정이면 예외를 던지지 않고 빈 리스트를 반환**해,  
  - FastAPI는 200 + `{received: 0, saved: 0}`을 반환하고,  
  - Backend는 `saved`만 파싱해 0을 그대로 노출한다.
- **0건의 직접 원인**  
  - **data-collector 컨테이너(또는 실행 환경)에 `DART_API_KEY`, `SEC_API_KEY`가 설정되어 있지 않음.**

---

## 6. 조치 사항

1. **docker-compose**  
   - `data-collector` 서비스에 **`DART_API_KEY`**, **`SEC_API_KEY`** 환경변수를 추가한다.  
   - 값은 `.env`에서 주입 가능하도록 `${DART_API_KEY:}`, `${SEC_API_KEY:}` 형태로 두고, 실제 키는 운영/로컬 `.env`에 설정한다.
2. **키 발급**  
   - **DART**: [Open DART](https://opendart.fss.or.kr)에서 인증키 발급.  
   - **SEC**: SEC EDGAR API 키(해당 프로젝트에서 사용하는 방식·문서 기준) 발급 후 동일한 키를 `SEC_API_KEY`로 설정.
3. **문서**  
   - `plans/infra/로컬_환경_설정_점검.md` 등에 **뉴스·공시 수집 시 DART_API_KEY·SEC_API_KEY 필수**임을 명시한다.

---

## 7. 변경 이력

- 2026-02-21: 최초 작성. 0건 원인(DART_API_KEY·SEC_API_KEY 미설정), Python 흐름, 결론·조치 정리.
