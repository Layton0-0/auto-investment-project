# daily-chart 404 / settings 400 API 오류 대응

**일시**: 2026-02-21  
**현상**
- `GET http://localhost/api/v1/market-data/daily-chart?symbol=005930&market=KR` → 404 (Not Found)
- `GET http://localhost/api/v1/settings/69569325-01` → 400 (Bad Request)

## 원인 및 조치

### 1. daily-chart 404

- **가능 원인**
  - `/api/v1/market-data/**` 가 인증 필요 경로라, 토큰 없을 때 401이 나와 일부 환경에서 404처럼 보일 수 있음.
  - 또는 백엔드 미기동/프록시 오설정 시 502가 나오는데, 사용 환경에 따라 404로 표시될 수 있음.
- **조치 (반영됨)**
  - **SecurityConfig**: `GET /api/v1/market-data/**` 를 `permitAll()` 로 추가하여, 비인증으로도 일봉 차트 조회 가능하도록 변경.
  - 로그인 없이 대시/차트용 시세·일봉 조회만 허용하는 수준으로 제한.

**추가 확인 사항**
- 로컬 풀 스택 사용 시: `docker compose -f docker-compose.local-full.yml up -d` 로 backend·nginx·frontend 기동 여부 확인.
- Vite 단독 실행 시: `vite.config.ts` 의 `/api` → `http://localhost:8080` 프록시로 백엔드 8080 기동 여부 확인.
- 404가 계속되면 브라우저 개발자 도구에서 실제 요청 URL·응답 본문 확인.

### 2. settings/69569325-01 400

- **가능 원인**
  - PathVariable `accountNo` 가 `69569325-01` 처럼 하이픈 포함일 때, 경로 매칭/파싱 이슈로 400(ConstraintViolation 등)이 발생할 수 있음.
- **조치 (반영됨)**
  - **SettingController**
    - `GET /{accountNo}`, `PUT /{accountNo}` 에 path variable 정규식 명시: `@GetMapping("/{accountNo:[^/]+}")`, `@PutMapping("/{accountNo:[^/]+}")`
    - `@PathVariable("accountNo")` 로 명시하여 슬래시 제외한 전체 세그먼트(예: `69569325-01`)가 그대로 바인딩되도록 함.
  - 계좌번호 형식(숫자-숫자 등)이 path에서 잘리지 않도록 함.

**추가 확인 사항**
- 설정 없을 때는 백엔드가 404를 반환하고, 프론트 `getSettingByAccountNo` 는 404/400 모두 null 로 처리하므로 동작은 유지됨.
- 400이 계속되면 백엔드 로그에서 `ConstraintViolationException` / `INVALID_INPUT` 여부 확인.

## 변경 파일

| 파일 | 변경 내용 |
|------|-----------|
| `investment-backend/.../SecurityConfig.java` | `GET /api/v1/market-data/**` permitAll 추가, HttpMethod import |
| `investment-backend/.../SettingController.java` | `{accountNo:[^/]+}`, `@PathVariable("accountNo")` 명시, 미사용 HttpStatus import 제거 |

## 검증

- `GET /api/v1/market-data/daily-chart?symbol=005930&market=KR` → 200, body 배열(또는 빈 배열).
- `GET /api/v1/market-data/ping` → 200 "ok" (컨트롤러 도달 여부 확인용).
- `GET /api/v1/settings/69569325-01` (인증 헤더 포함) → 200(설정 있음) 또는 404(설정 없음). 404 시 JSON `{"code":"SETTING_NOT_FOUND","message":"거래 설정을 찾을 수 없습니다: ..."}` 는 정상이며, 프론트는 404면 null로 처리해 기본 폼 표시.

---

## (추가) daily-chart "페이지 찾을 수 없다" 404 계속 시

1. **컨트롤러 도달 확인**  
   브라우저에서 `http://localhost/api/v1/market-data/ping` 호출.
   - **200 "ok"** → 컨트롤러까지 도달함. 이때 `/daily-chart` 만 404면 경로/메서드 이슈 가능. 백엔드 재빌드 후 재시도.
   - **502 / 연결 실패** → 백엔드 미기동. Docker 사용 시 `docker compose -f docker-compose.local-full.yml up -d` 후 backend 로그 확인.
   - **404** → `/api` 요청이 백엔드로 가지 않음. **nginx가 80번에서 동작 중인지**, 로컬 풀 스택이면 `conf.d.local` 이 로드되는지 확인. 프론트만 80번에서 서빙 중이면 `/api` 는 없으므로 404가 남. 이 경우 백엔드를 8080에서 띄우고 `VITE_API_BASE_URL=http://localhost:8080` 또는 Vite proxy로 8080 연결.

2. **백엔드 재빌드 (로컬에서 코드 변경 반영)**  
   - **원인**: 기존 `Dockerfile`은 **이미 만든 JAR**(`build/libs/*.jar`)만 복사합니다. 코드 수정 후 `./gradlew bootJar`를 안 하면 예전 JAR가 그대로 이미지에 들어가서 변경이 안 보입니다.  
   - **해결**: 로컬 전용 `Dockerfile.local`(멀티스테이지, 소스에서 Gradle 빌드)을 쓰도록 변경했습니다.  
   - **실행**: `investment-infra` 디렉터리에서  
     `docker compose -f docker-compose.local-full.yml up -d --build backend`  
     첫 빌드는 수 분 걸릴 수 있습니다.  
   - **캐시 무시하고 완전 재빌드**: `docker compose -f docker-compose.local-full.yml build --no-cache backend` 후 `up -d backend`.

3. **직접 백엔드 호출**  
   백엔드만 8080에서 실행 중일 때: `http://localhost:8080/api/v1/market-data/daily-chart?symbol=005930&market=KR` 로 호출해 200/404 여부 확인.
