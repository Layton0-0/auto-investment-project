# 데이터 파이프라인 메뉴 API 오류 원인 및 대응

**일시**: 2026-02-21  
**요약**: 데이터 파이프라인(/ops/data) 및 공통 레이아웃에서 발생한 502/404/400 오류 원인 정리 및 배치 API 404 수정 완료.

---

## 1. 콘솔 오류 목록


| URL                                                       | 상태                  | 원인·대응                                                            |
| --------------------------------------------------------- | ------------------- | ---------------------------------------------------------------- |
| `/api/v1/auth/mypage`                                     | **502** Bad Gateway | 백엔드 장애 또는 mypage 처리 중 예외. 프록시가 백엔드 응답을 받지 못함.                    |
| `/api/v1/market-data/daily-chart?symbol=005930&market=KR` | **404**             | 백엔드에는 구현됨(MarketDataController). 프록시/백엔드 URL 불일치 또는 구버전 배포 가능성.  |
| `/api/v1/settings/69569325-01`                            | **400** → **404**  | 해당 계좌에 거래 설정 없을 때. GlobalExceptionHandler에서 SETTING_NOT_FOUND → 404 매핑 적용함. |
| `/batch/api/jobs`                                         | **404** Not Found   | nginx가 `/api`만 백엔드로 전달. `/batch`는 프론트로 가서 404. **→ 수정 완료**       |


---

## 2. 조치 완료: 배치 목록 404

- **원인**: nginx `location /api` 만 백엔드로 전달. `GET /batch/api/jobs`는 백엔드로 가지 않음.
- **조치**:
  - 백엔드에 **GET /api/v1/batch/jobs** 추가 (`BatchController`, `BatchManagementService` 재사용).
  - 프론트 `batchApi.getBatchJobs()` 호출 경로를 **/api/v1/batch/jobs** 로 변경.
- **결과**: 데이터 파이프라인 화면의 "스케줄 현황 (Batch Jobs)" 테이블이 동일 base URL에서 정상 조회됨.

---

## 3. 나머지 오류 점검 방법

### 3.1 mypage 502 (Bad Gateway) — 왜 발생하는가

**502 의미**: 브라우저는 `http://localhost`(nginx)에 요청하고, nginx는 `proxy_pass http://backend:8080`으로 백엔드에 넘깁니다. **502는 nginx가 백엔드로부터 정상적인 HTTP 응답을 받지 못했을 때** 반환합니다.

**발생 가능 원인** (우선순위 순):


| 원인                 | 설명                                                                                 | 확인 방법                                                                          |
| ------------------ | ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| **1. 백엔드 미기동**     | `backend:8080`에 연결 불가(컨테이너/프로세스 중지)                                                | `docker ps` 또는 로컬이면 백엔드 프로세스 실행 여부 확인. nginx error_log에 `connection refused` 등 |
| **2. 백엔드 처리 중 예외** | mypage 처리 중 미처리 예외로 연결 끊김 또는 비정상 응답                                                | 백엔드 로그에서 `GET /api/v1/auth/mypage` 직후 스택 트레이스 검색. `traceId`로 에러 응답과 매칭         |
| **3. 암복호화 실패**     | `AuthService.getMyPage()` 내부에서 `encryptionUtil.decrypt()`(API Key/Secret, 계좌번호) 실패 | 암호화 키/알고리즘 변경 여부, DB에 저장된 암호문과 현재 키 일치 여부 확인. 예외 메시지에 "decrypt" 등              |
| **4. DB 연결 실패**    | User/UserApiKey/UserAccount 조회 시 DB 타임아웃·연결 끊김                                     | DB 컨테이너/인스턴스 기동, connection pool, 백엔드 로그의 DB 예외 확인                             |
| **5. 업스트림 타임아웃**   | 백엔드 응답이 느려 nginx `proxy_read_timeout` 초과                                           | nginx 기본 60초. 백엔드 로그에서 mypage 처리 시간 확인                                         |


**getMyPage 처리 흐름** (예외 발생 가능 지점):

1. JWT 인증 통과 → `userId` 추출
2. `userRepository.findById(userId)` → USER_NOT_FOUND 시 4xx (보통 502 아님)
3. `userApiKeyRepository.findByUserId(userId)` → 비어 있으면 API_KEY_NOT_FOUND (4xx)
4. `**encryptionUtil.decrypt(appKeyEncrypted)` / `decrypt(appSecretEncrypted)`** → 키 불일치·손상 시 예외 → 500/502 가능
5. (메인 계좌 있으면) `encryptionUtil.decrypt(accountNoEncrypted)` → 동일
6. `MyPageResponseDto` 반환

**즉시 확인할 것**:

- 백엔드가 **실행 중인지** (같은 docker-compose/네트워크에서 `backend:8080` 접근 가능한지).
- 백엔드 **표준 출력/로그**에서 mypage 호출 시점의 **Exception/Error** 유무.
- 최근 **암호화 키(ENCRYPTION_KEY 등)** 또는 DB 복원 후 **암호문과 키 불일치** 가능성.

### 3.2 daily-chart 404

- **원인**: 백엔드 소스에는 `MarketDataController`에 `GET /api/v1/market-data/daily-chart`가 있으나, **Docker 사용 시 예전에 빌드된 backend 이미지**가 올라와 있으면 해당 경로가 없어 404 발생.
- **즉시 확인**: 로컬 풀 스택 사용 시 backend 이미지 재빌드 후 재기동.
  ```bash
  cd investment-infra
  docker compose -f docker-compose.local-full.yml up -d --build backend
  ```
- 브라우저 base URL이 nginx(예: `http://localhost`)로 가고, nginx가 `/api`를 backend:8080으로 넘기면 동일 경로로 백엔드에 전달됨. 별도 VITE_API_BASE_URL은 프론트가 `/api` 호출 시 상대 경로면 동일 호스트 사용.

### 3.3 settings 400 → 404

- **조치**: `GlobalExceptionHandler`에서 `ErrorCode.SETTING_NOT_FOUND` 시 **404** 반환하도록 매핑 추가. (기존: 400)
- SettingController는 설정 없을 때 `ResponseEntity.notFound().build()`로 이미 404 반환. 다른 경로에서 SETTING_NOT_FOUND 예외가 나면 이제 404로 통일됨.
- 프론트 `getSettingByAccountNo`는 404/400 모두 null로 처리하므로 동작은 동일. 콘솔에는 404만 표시됨.

---

## 4. 참고

- 배치 API: [02-api-endpoints.md](../../investment-backend/docs/04-api/02-api-endpoints.md) §7, [11-api-frontend-mapping.md](../../investment-backend/docs/04-api/11-api-frontend-mapping.md) §5.1.
- 데이터 파이프라인 화면: `getDataPipelineStatus()` (GET /api/v1/ops/data-pipeline/status) + `getBatchJobs()` (GET /api/v1/batch/jobs). 둘 다 `/api` prefix 사용 시 nginx 통해 백엔드 도달.

