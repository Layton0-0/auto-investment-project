# 퀀트트레이더 시스템 QA 시나리오 및 오류 분석

**작성일:** 2026-02-21  
**목적:** 현재 프론트엔드에서 발생 중인 API 오류 4건 원인 분석 및 QA 시나리오 정리

---

## 1. 오류 요약 및 원인

| # | API | HTTP 상태 | 원인 요약 |
|---|-----|-----------|-----------|
| 1 | `GET /api/v1/auth/mypage` | **500** | 서버 내부 예외(인증 통과 후 getMyPage 처리 중) |
| 2 | `GET /api/v1/market-data/daily-chart?symbol=005930&market=KR` | **404** | 백엔드에 해당 엔드포인트 미구현 |
| 3, 4 | `GET /api/v1/settings/50161075-01`, `GET /api/v1/settings/69569325-01` | **400** | 해당 계좌번호에 대한 거래 설정(TradingSetting)이 DB에 없음 |

---

## 2. 상세 원인 분석

### 2.1 GET /api/v1/auth/mypage → 500 (Internal Server Error)

- **위치:** `AuthController.getMyPage()` → `AuthService.getMyPage(userId)`
- **정상 시:** 인증된 사용자면 200 + `MyPageResponseDto` 반환.
- **500이 나는 경우:** `DomainException`(USER_NOT_FOUND, API_KEY_NOT_FOUND)이면 전역 핸들러에서 **400/401**로 매핑되므로, 500은 **그 외 비즈니스 예외가 아닌 예외**에서 발생.
- **가능 원인:**
  - `EncryptionUtil.decrypt()` 실패 (암호화 키/환경 변수 불일치, `.env` 누락 등)
  - DB 연결 오류 또는 조회 중 런타임 예외
  - `User`/`UserApiKey`/`UserAccount` 엔티티 또는 연관 데이터 이상
- **확인 방법:** 백엔드 로그에서 `/api/v1/auth/mypage` 호출 시 스택 트레이스 확인. `traceId`로 에러 응답과 로그 매칭.

### 2.2 GET /api/v1/market-data/daily-chart → 404 (Not Found)

- **사실:** `MarketDataController`에는 **daily-chart 엔드포인트가 없음**.
- **현재 구현:** `/api/v1/market-data/current-price/{symbol}`, `POST /api/v1/market-data/current-prices` 만 존재.
- **프론트:** `investment-front` / `investment-frontend`의 `marketDataApi.getDailyChart(symbol, market, from?, to?)`에서 위 URL 호출.
- **결론:** 백엔드에 **일봉 차트 API를 추가**하거나, 프론트에서 해당 API 호출을 제거/대체(예: 현재가만 사용)해야 함.

### 2.3 GET /api/v1/settings/{accountNo} → 400 (Bad Request)

- **위치:** `SettingController.getSetting(accountNo)` → `TradingSettingService.getSetting(accountNo)`.
- **로직:** `TradingSettingRepository.findByAccountNo(accountNo)` 결과가 없으면 `DomainException(ErrorCode.SETTING_NOT_FOUND, "거래 설정을 찾을 수 없습니다: " + accountNo)` 발생.
- **전역 핸들러:** `SETTING_NOT_FOUND`는 `ACCOUNT_NOT_FOUND`/`UNAUTHORIZED`/`ORDER_REJECTED`가 아니므로 **HttpStatus.BAD_REQUEST(400)** 로 응답.
- **결론:** 계좌번호 `50161075-01`, `69569325-01`에 대해 DB에 **TradingSetting** 레코드가 없음.  
  - 설정 화면에서 “계좌별 거래 설정”을 조회하기 전에, 해당 계좌에 대한 거래 설정이 한 번이라도 저장되어 있어야 함.  
  - 또는 “설정 없음”일 때 404/빈 설정 반환으로 API 스펙 변경 검토.

---

## 3. QA 시나리오 (시나리오 기반 검증)

### 3.1 인증·마이페이지

| ID | 시나리오 | 단계 | 예상 결과 | 비고 |
|----|----------|------|-----------|------|
| A1 | 비로그인 마이페이지 | GET /api/v1/auth/mypage (쿠키 없음) | 401 | - |
| A2 | 로그인 후 마이페이지 | 로그인 → GET /api/v1/auth/mypage (유효 쿠키) | 200, 본인 정보 | 500 나오면 백엔드 로그·암복호화/DB 점검 |
| A3 | 토큰 만료/무효 | 만료/조작된 토큰으로 GET /api/v1/auth/mypage | 401 | - |

### 3.2 시장 데이터

| ID | 시나리오 | 단계 | 예상 결과 | 비고 |
|----|----------|------|-----------|------|
| M1 | 현재가 단일 조회 | GET /api/v1/market-data/current-price/005930 | 200, 현재가 DTO | 기존 구현 |
| M2 | 일봉 차트 조회 | GET /api/v1/market-data/daily-chart?symbol=005930&market=KR | 현재: 404 | 백엔드 구현 전까지 404 정상. 구현 후 200 기대 |

### 3.3 설정 (Settings)

| ID | 시나리오 | 단계 | 예상 결과 | 비고 |
|----|----------|------|-----------|------|
| S1 | 계좌 목록 조회 | GET /api/v1/settings/accounts (인증 O) | 200, 모의/실 계좌 블록 | - |
| S2 | 설정 있는 계좌 조회 | GET /api/v1/settings/{accountNo} (DB에 설정 존재) | 200, TradingSettingDto | accountNo 형식: 8자리 또는 8자리-2자리 등 스펙 확인 |
| S3 | 설정 없는 계좌 조회 | GET /api/v1/settings/{accountNo} (DB에 설정 없음) | 400, SETTING_NOT_FOUND | 현재 동작. 필요 시 404 또는 “기본값” 응답으로 스펙 변경 검토 |
| S4 | 설정 저장 | PUT /api/v1/settings/{accountNo} (body: TradingSettingDto) | 200 | 저장 후 S2 재호출 시 200 기대 |

### 3.4 통합 시나리오 (로그인 → 대시/설정 → 시세)

1. **로그인** → 토큰/쿠키 확보.
2. **마이페이지** GET → 200 확인 (500이면 원인 2.1 조사).
3. **설정 계좌 목록** GET → 200, 사용 계좌 목록 확인.
4. **각 계좌에 대해 설정 조회** GET → 설정이 있는 계좌는 200, 없는 계좌는 400(또는 변경 후 404/기본값).
5. **일봉 차트 호출** → 현재는 404; 백엔드 구현 후 200 및 차트 데이터 표시 확인.

---

## 4. REST Client로 전체 시나리오 실행 (권장)

- **파일:** [plans/qa/api-qa.http](api-qa.http)
- **순서:** 로그인(1) → 마이페이지(2) → 시장데이터(3,4) → 설정 계좌 목록(5) → 계좌별 설정 조회/저장(6,7) → 로그아웃(8).
- **방법:**
  1. `api-qa.http` 상단에서 `@baseUrl`, `@token` 확인. (다른 호스트면 baseUrl 수정)
  2. **로그인** 블록에서 `username`, `password`를 실제 계정으로 수정 후 **Send Request** 실행.
  3. 응답 body에서 `token` 값을 복사해 `@token = YOUR_JWT_HERE` 자리에 붙여넣기.
  4. 나머지 요청은 블록별로 **Send Request**로 순서대로 실행. (각 요청에 `Authorization: Bearer {{token}}` 이 들어 있어 동일 토큰으로 2~8번 실행됨.)
- **로그 검증:** 각 요청 직후 로컬 백엔드 로그를 확인. 예상 코드·로그 키워드는 **[QA 로그검증 시나리오](20260221-1200_QA_로그검증_시나리오.md)** 참고.

### 검증 체크리스트 (실행 후 기입)

| # | 요청 | 예상 코드 | 실제 코드 (동일 토큰·Bearer) | 비고 |
|---|------|-----------|------------------------------|------|
| 1 | 로그인 | 200 | **200** | JWT 발급 |
| 2 | 마이페이지 | 200 | **200** | Authorization: Bearer 사용 시 정상 |
| 3 | 현재가 005930 | 200 | **200** | - |
| 4 | 일봉 차트 | 404 | **404** | 엔드포인트 미구현 |
| 5 | 설정 계좌 목록 | 200 | **200** | - |
| 6 | 설정 조회(12345678) | 200/400 | **400** | SETTING_NOT_FOUND (해당 계좌 설정 없음) |
| 6-2 | 설정 조회(50161075-01) | 200/400 | **400** | 저장 전에는 없음 |
| 7 | 설정 저장(PUT 50161075-01) | 200 | **200** | 저장 성공 |
| 8 | 로그아웃 | 200 | **200** | - |

**동일 토큰 방식 (에이전트 직접 실행·로컬):**
- **로그인 1회** → 응답에서 `token` 추출 → **Authorization: Bearer {token}** 으로 2~8번 요청에 동일하게 사용.
- 위 표는 그 방식으로 한 번에 실행한 결과. **Cookie만 보내면** 프록시/클라이언트에 따라 401이 날 수 있으므로, REST Client·스크립트에서는 **Bearer 헤더 사용 권장**.
- `api-qa.http`에는 모든 인증 요청에 `Authorization: Bearer {{token}}` 를 추가해 두었음.

---

## 5. 직접 실행 가능한 검증 (curl/로컬)

- **Base URL:** `http://localhost` (또는 nginx/백엔드 실제 호스트)
- **인증:** 로그인 후 받은 쿠키(`token`)를 함께 보냄.

```bash
# 1) 마이페이지 (인증 필요)
curl -s -o /dev/null -w "%{http_code}" -b "token=YOUR_JWT" "http://localhost/api/v1/auth/mypage"

# 2) 일봉 차트 (인증 없음: 401, 인증 있음: 404 - 엔드포인트 미구현)
curl -s -o /dev/null -w "%{http_code}" "http://localhost/api/v1/market-data/daily-chart?symbol=005930&market=KR"

# 3) 설정 조회 (인증 필요, 설정 없는 계좌면 400)
curl -s -o /dev/null -w "%{http_code}" -b "token=YOUR_JWT" "http://localhost/api/v1/settings/50161075-01"
```

- **백엔드 로그:** 500 발생 시 `traceId`와 스택 트레이스를 확인하면 원인 특정에 유리함.

---

## 6. 수정 제안 요약

| 구분 | 제안 | 우선순위 |
|------|------|----------|
| mypage 500 | 로그/스택 트레이스로 원인 특정 후, 암호화 키·DB·엔티티 등 점검. 필요 시 DomainException으로 치환해 4xx 처리 | 높음 |
| daily-chart 404 | 백엔드에 `GET /api/v1/market-data/daily-chart` 구현(한국투자 API 등 연동) 또는 프론트에서 호출 제거/대체 | 높음 |
| settings 400 | “설정 없음”을 404 또는 빈 기본값(200)으로 반환하도록 API/프론트 협의. 또는 최초 진입 시 해당 계좌로 설정 자동 생성 | 중간 |

---

## 7. QA에 유용한 MCP/도구

- **API 호출 검증:** REST Client(VSCode 확장), Postman, 또는 터미널 `curl`로 위 시나리오 재현.
- **백엔드 로그:** Docker/로컬 로그에서 `traceId`, `DomainException`, `Exception` 스택 확인.
- **DB 확인:** SQLcl 등으로 `TRADING_SETTING`(또는 해당 테이블명)에 `50161075-01`, `69569325-01` 계좌 존재 여부 확인 (SELECT만).
- **한국투자 API:** 일봉 차트 구현 시 한국투자 코딩도우미 MCP로 일봉/기간별 시세 API 검색 후 연동.

---

## 8. 참고 소스

- `investment-backend`: `AuthController`, `AuthService.getMyPage`, `MarketDataController`, `SettingController`, `TradingSettingService.getSetting`, `GlobalExceptionHandler`
- `investment-front` / `investment-frontend`: `authApi`, `marketDataApi.getDailyChart`, `settingsApi`
