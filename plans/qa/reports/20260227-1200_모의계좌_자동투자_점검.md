# 모의계좌 자동투자 준비 점검 리포트

**점검 일시**: 2026-02-27  
**계획 참조**: 모의계좌 자동투자 준비 점검 계획 (§2 점검 체크리스트)

---

## 1. 서버(Backend) 설정 요약

| 항목 | 점검 결과 |
|------|-----------|
| **파이프라인 자동 실행** | `investment.pipeline.auto-execute` = `${PIPELINE_AUTO_EXECUTE:false}` (기본 false). 계정별 `PIPELINE_AUTO_EXECUTE`가 true이면 해당 계좌만 실제 주문. |
| **실전 계좌 실행 허용** | `investment.pipeline.allow-real-execution` = `${PIPELINE_ALLOW_REAL_EXECUTION:false}` (기본 false). 모의계좌만 실제 주문. |
| **스케줄러 기본 자본** | `investment.pipeline.scheduler.default-capital` = `${PIPELINE_SCHEDULER_DEFAULT_CAPITAL:0}`. 계정별 MAX_INVESTMENT_AMOUNT 없으면 0이면 실행 스킵. |

- **적용 경로**: Backend는 [docker-compose.local-full.yml](../../investment-infra/docker-compose.local-full.yml) 기준 `investment-backend/.env`를 env_file로 로드. 위 항목은 `.env`에 없으면 application.yml 기본값 사용.
- **결론**: 기본값만 사용 시 모의계좌에서 실제 주문하려면 계정별 `pipeline_auto_execute = true` 또는 서버 `PIPELINE_AUTO_EXECUTE=true` 필요.

---

## 2. DB 점검 결과

**DB**: TimescaleDB(PostgreSQL), Compose 서비스명 `investment-timescaledb`, DB명 `investment_portfolio`, 사용자 `local_pg`.

### 2.1 자동투자 ON인 거래설정 (TB_TRADING_SETTINGS)

| ACCOUNT_NO (마스킹) | USER_ID | MAX_INVESTMENT_AMOUNT | AUTO_TRADING_ENABLED | ROBO_ADVISOR_ENABLED | PIPELINE_AUTO_EXECUTE | PIPELINE_ALLOW_REAL_EXECUTION |
|---------------------|---------|------------------------|----------------------|----------------------|------------------------|-------------------------------|
| 5016****-01         | (NULL)  | 10,000,000             | true                 | false                | false                  | false                         |

- **행 수**: 1.
- **확인**: `MAX_INVESTMENT_AMOUNT > 0` 충족. `PIPELINE_AUTO_EXECUTE`가 false이므로 서버 기본값(`auto-execute`) 또는 계정별 true 설정이 있어야 해당 계좌에서 실제 주문 실행됨.

### 2.2 모의계좌 등록 현황 (TB_USER_ACCOUNTS, SERVER_TYPE=1)

| SERVER_TYPE | USER_ID | account_count |
|-------------|---------|----------------|
| 1           | d13fe2f1-3c22-430e-87df-968c117b72cd | 1 |

- **행 수**: 1명 1계좌(모의).
- **매칭**: TB_TRADING_SETTINGS의 해당 행은 USER_ID가 NULL로 조회됨. 모의계좌와의 대응은 앱에서 계좌번호(복호화) 기준으로 수행. API `GET /api/v1/user/accounts?serverType=1` 및 `GET /api/v1/settings/{accountNo}`로 매칭 확인 권장.

### 2.3 점검용 SQL 스크립트

재실행용 스크립트: [plans/qa/scripts/모의계좌_자동투자_점검.sql](../scripts/모의계좌_자동투자_점검.sql)

```powershell
# Docker에서 실행 예시
cd investment-infra
Get-Content ..\plans\qa\scripts\모의계좌_자동투자_점검.sql | docker exec -i investment-timescaledb psql -U local_pg -d investment_portfolio
```

---

## 3. 배치 스케줄 확인

- **로그 출처**: `docker compose -f docker-compose.local-full.yml logs backend` (기동 구간).
- **결과**: `BatchJobScheduler`에서 **auto-buy** 스케줄 등록 확인.
  - `Scheduled batch job: id=auto-buy, cron=0 10 9 * * *` (매일 09:10 KST).
- **기타 등록 Job**: trading-portfolio-generator, factor-calculation, pipeline-exit, fill-confirmation, unfilled-order-check, risk-event-alert, daily-pnl, intraday-breakout, strategy-governance-check 등.

---

## 4. 수동 트리거 dryRun 검증 (선택)

- **요청**: `POST /api/v1/trigger/auto-buy?dryRun=true`
- **결과**: 인증 필요. 미인증 시 **401 Unauthorized** (정상).
- **권장**: 인증 후 동일 요청으로 1회 실행해 Backend 로그에서 "자동매수(통합) 시작", 대상 계좌·스킵 사유 메시지 확인.

---

## 5. 종합

- **준비 상태**: DB에 자동투자 ON인 거래설정 1건, 모의계좌(SERVER_TYPE=1) 1건 존재. auto-buy 09:10 스케줄 등록됨.
- **실제 주문 실행 조건**: 해당 계좌에서 파이프라인 실제 주문을 하려면 서버 `PIPELINE_AUTO_EXECUTE=true` 또는 해당 계정의 `PIPELINE_AUTO_EXECUTE=true` 필요. 현재 DB상 계정별 값은 false.
- **다음 점검**: 정기(예: 주 1회) 또는 배포 전 동일 체크리스트·SQL 재실행 권장.
