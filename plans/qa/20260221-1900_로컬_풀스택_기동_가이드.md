# 로컬 풀스택 기동 가이드 (Docker Compose)

**작성일**: 2026-02-21  
**목적**: docker-compose.local-full.yml 기반 풀스택 기동·헬스 확인·트러블슈팅. 전체 메뉴 QA 시 브라우저에서 http://localhost 사용.

---

## 1. 서비스 구성

| 서비스 | 이미지 | 포트(호스트) | 역할 |
|--------|--------|---------------|------|
| timescaledb | timescale/timescaledb:2.13.0-pg16 | 5432 | DB |
| redis | redis:7-alpine | 6379 | 캐시 |
| backend | investment-backend:local | 8080 | Spring Boot API |
| prediction-service | investment-prediction-service:local | 8000 | AI 예측 |
| data-collector | investment-data-collector:local | 8001 | 데이터 수집 |
| frontend | investment-frontend:local | (내부 80) | React SPA |
| nginx | nginx:alpine | **80** | /api → backend, / → frontend |

- **접속**: 브라우저에서 **http://localhost** 사용. API는 **http://localhost/api** (nginx 경유). 배치 Job 목록은 **http://localhost/batch/api/jobs** (nginx가 /batch → backend 프록시).

---

## 2. 기동 방법

### 2.1 스크립트 사용 (권장)

```powershell
cd investment-infra
.\scripts\local-up.ps1
```

- Backend JAR가 없으면 스크립트가 `investment-backend`에서 `.\gradlew.bat bootJar` 실행 후 compose 기동.
- `docker-compose.local-full.yml` + `investment-infra\.env` 사용.

### 2.2 수동 기동

```powershell
cd investment-infra
docker compose -f docker-compose.local-full.yml up -d --build
```

- Backend는 **Dockerfile.local**로 컨테이너 내부에서 `./gradlew bootJar` 후 실행. 호스트에서 미리 JAR 빌드할 필요 없음.

---

## 3. 필수 환경 변수

- **investment-infra/.env**  
  - `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`: DB 접속. 미설정 시 기본값(local_pg, local_pg_pass, investment_portfolio) 사용.
  - `DART_API_KEY`, `SEC_API_KEY`: 비워두면 뉴스 수집 0건. 기동 자체는 가능.

- **investment-backend/.env**  
  - Compose가 이 파일을 backend 컨테이너에 `env_file`로 전달.
  - 한국투자증권: `KOREA_INVESTMENT_APP_KEY`, `KOREA_INVESTMENT_APP_SECRET`, `KOREA_INVESTMENT_SERVER_TYPE` (1=모의, 0=실전).
  - DB/Redis는 Compose `environment`로 override (timescaledb, redis 호스트명).

---

## 4. 헬스 확인

| 확인 항목 | 방법 | 기대 |
|-----------|------|------|
| Backend (직접) | `http://localhost:8080/actuator/health` | 200, `{"status":"UP"}` |
| Backend (nginx 경유) | `http://localhost/api/actuator/health` | 200 (SecurityConfig에 `/api/actuator/health` permit 추가됨) |
| Frontend (nginx 경유) | `http://localhost/` | 200, HTML (SPA) |
| 서비스 목록 | `docker compose -f docker-compose.local-full.yml ps` | 모든 서비스 Up |

- Frontend 502 시: `docker logs investment-frontend` 및 `docker logs investment-nginx-local` 확인. nginx가 `frontend:80`으로 연결 실패 시 컨테이너 네트워크/재시작 확인.

---

## 5. 트러블슈팅

| 현상 | 조치 |
|------|------|
| Backend 기동 실패 (DB 연결 등) | `docker logs investment-backend` 확인. TimescaleDB healthy 대기 후 재기동. |
| /api/actuator/health 401 | Backend SecurityConfig에 `/api/actuator/health` permit 추가 후 재빌드. |
| Frontend 502 | nginx 로그에서 `upstream "http://...frontend:80"` Connection refused 여부 확인. `docker restart investment-frontend investment-nginx-local` |
| Ops 데이터 파이프라인 배치 목록 502 | nginx에 location /batch 추가 후 `docker restart investment-nginx-local` |
| 뉴스 수집 0건 | data-collector에 DART_API_KEY, SEC_API_KEY 설정. (선택) |
| 로그인 후 API 401 | 토큰 만료 또는 Authorization 헤더 확인. |

---

## 6. 전체 메뉴 QA 시

1. 위 절차로 풀스택 기동.
2. 브라우저에서 **http://localhost** 접속 → 로그인.
3. 상단 계좌 탭에서 **모의계좌(serverType=1)** / **실계좌(serverType=0)** 전환.
4. 좌측 메뉴에서 대시보드·자동투자·국내/미국 전략·뉴스·포트폴리오·주문·백테스트·설정·연말 세금·리포트·Ops 메뉴 순으로 진입하며 버튼 클릭.
5. 각 화면에서 유효 데이터 또는 명시적 빈 상태 메시지 확인 (한국투자증권 기준).

---

## 7. 참고

- [최종_QA_체크리스트.md](최종_QA_체크리스트.md)
- [docker-compose.local-full.yml](../investment-infra/docker-compose.local-full.yml)
- [local-up.ps1](../investment-infra/scripts/local-up.ps1)
